#!/bin/sh
# This is a NetworkManager dispatcher script for chronyd to update
# its NTP sources passed from DHCP options. Note that this script is
# specific to NetworkManager-dispatcher due to use of the
# DHCP4_NTP_SERVERS environment variable. For networkd-dispatcher,
# an alternative approach is external means such as a dhclient hook.

export LC_ALL=C

# If a dhclient installation is present, avoid a redundant operation
# with dhclient which handles NTP server config through its own
# NetworkManager dispatcher script 11-dhclient.
[ -e /usr/sbin/dhclient ] && exit 0

interface=$1
action=$2

chrony_helper=@CHRONY_HELPER@
default_server_options=@CHRONY_DEFAULT_SERVER_OPTIONS@
server_dir=@CHRONY_SERVER_DIR@

dhcp_server_file=$server_dir/chrony.servers.$interface
# DHCP4_NTP_SERVERS is passed from DHCP options by NetworkManager.
nm_dhcp_servers=$DHCP4_NTP_SERVERS

[ -f /etc/sysconfig/network ] && . /etc/sysconfig/network
[ -f /etc/sysconfig/network-scripts/ifcfg-"${interface}" ] && \
    . /etc/sysconfig/network-scripts/ifcfg-"${interface}"

add_servers_from_dhcp() {
    rm -f "$dhcp_server_file"

    # Don't add NTP servers if PEERNTP=no specified; return early.
    [ "$PEERNTP" = "no" ] && return

    for server in $nm_dhcp_servers; do
        echo "$server $default_server_options" >> "$dhcp_server_file"
    done
    $chrony_helper update-daemon || :
}

clear_servers_from_dhcp() {
    if [ -f "$dhcp_server_file" ]; then
        rm -f "$dhcp_server_file"
        $chrony_helper update-daemon || :
    fi
}

mkdir -p $server_dir

if [ "$action" = "up" ] || [ "$action" = "dhcp4-change" ]; then
    add_servers_from_dhcp
elif [ "$action" = "down" ]; then
    clear_servers_from_dhcp
fi

exit 0
